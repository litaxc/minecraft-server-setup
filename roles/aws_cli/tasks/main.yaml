- name: Check if AWS CLI is already installed
  stat:
    path: /usr/local/aws-cli/v2/current
  register: result

- name: Download and install AWS CLI
  when: not result.stat.exists
  block:
    - name: Download AWS CLI
      unarchive:
        src: "https://awscli.amazonaws.com/awscli-exe-linux-{{ ansible_architecture }}.zip"
        dest: /tmp
        remote_src: yes

    - name: Install AWS CLI
      become: yes
      command: /tmp/aws/install

- name: Verify AWS CLI Installation
  command: /usr/local/bin/aws --version
  changed_when: false

- name: Create .aws directory
  file:
    path: "{{ ansible_env.HOME }}/.aws"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0700

- name: copy config
  copy:
    src: config
    dest: "{{ ansible_env.HOME }}/.aws"
    mode: 0600

- name: copy credentials
  copy:
    src: credentials
    dest: "{{ ansible_env.HOME }}/.aws"
    mode: 0600
